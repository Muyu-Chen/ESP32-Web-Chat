<!DOCTYPE html>
<html>
<head>
    <title>ESP32 Chat</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; background-color: #f0f0f0; }
        #header { padding: 10px; background-color: #4CAF50; color: white; text-align: center; }
        #header input { padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
        #messages { flex-grow: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column-reverse; }
        .message { background-color: white; padding: 8px 12px; margin-bottom: 8px; border-radius: 7px; max-width: 70%; word-wrap: break-word; }
        .message.mine { background-color: #dcf8c6; align-self: flex-end; }
        .message .from { font-weight: bold; color: #4CAF50; }
        .message .timestamp { font-size: 0.8em; color: #888; margin-left: 10px; }
        .system { text-align: center; color: #888; font-style: italic; margin-bottom: 8px; }
        #form { display: flex; padding: 10px; background-color: #fff; }
        #input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 20px; }
        #send { padding: 10px 20px; margin-left: 10px; background-color: #4CAF50; color: white; border: none; border-radius: 20px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="header">
        <span>Nickname: </span>
        <input type="text" id="nickname" placeholder="Enter your name">
    </div>

    <div id="messages"></div>

    <form id="form" onsubmit="sendMessage(event)">
        <input type="text" id="input" autocomplete="off" placeholder="Type a message..."/>
        <button id="send">Send</button>
    </form>

    <script>
        const messages = document.getElementById('messages');
        const form = document.getElementById('form');
        const input = document.getElementById('input');
        const nicknameInput = document.getElementById('nickname');
        
        let ws;
        let userId = localStorage.getItem('esp-chat-uuid');
        if (!userId) {
            userId = crypto.randomUUID();
            localStorage.setItem('esp-chat-uuid', userId);
        }

        nicknameInput.value = localStorage.getItem('esp-chat-nickname') || `User${Math.floor(Math.random() * 1000)}`;
        nicknameInput.addEventListener('change', () => {
            localStorage.setItem('esp-chat-nickname', nicknameInput.value);
            showSystemMessage(`You changed your nickname to: ${nicknameInput.value}`);
        });

        function showMessage(msg) {
            const item = document.createElement('div');
            item.classList.add('message');
            
            const from = document.createElement('div');
            from.classList.add('from');
            from.textContent = msg.name;

            const data = document.createElement('div');
            data.textContent = msg.data;

            const timestamp = document.createElement('span');
            timestamp.classList.add('timestamp');
            timestamp.textContent = new Date(msg.timestamp * 1000).toLocaleTimeString();

            if (msg.from === userId) {
                item.classList.add('mine');
            }

            item.appendChild(from);
            item.appendChild(data);
            item.appendChild(timestamp);
            messages.prepend(item);
        }

        function showSystemMessage(text) {
            const item = document.createElement('div');
            item.classList.add('system');
            item.textContent = text;
            messages.prepend(item);
        }

        function connect() {
            const host = window.location.hostname;
            ws = new WebSocket(`ws://${host}/ws`);

            ws.onopen = () => {
                showSystemMessage('Connected to the server.');
                // Here you could request message history since last seen ID
            };

            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                // Simple client-side filtering for private messages
                if (msg.to && msg.to.users && !msg.to.all) {
                    if (msg.to.users.includes(userId) || msg.from === userId) {
                        showMessage(msg);
                    }
                } else { // Public message
                    showMessage(msg);
                }
            };

            ws.onclose = () => {
                showSystemMessage('Disconnected. Trying to reconnect in 3 seconds...');
                setTimeout(connect, 3000);
            };

            ws.onerror = (error) => {
                console.error('WebSocket Error:', error);
                ws.close();
            };
        }

        function sendMessage(event) {
            event.preventDefault();
            if (input.value && ws.readyState === WebSocket.OPEN) {
                const msg = {
                    type: 'text',
                    from: userId,
                    to: { all: true, users: [] }, // Simple public message for now
                    name: nicknameInput.value,
                    data: input.value,
                    id: 0, // Server should assign ID
                    timestamp: Math.floor(Date.now() / 1000)
                };
                ws.send(JSON.stringify(msg));
                input.value = '';
            }
        }
        
        connect();
    </script>
</body>
</html>
