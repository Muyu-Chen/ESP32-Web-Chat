# ESP32 聊天服务器 Demo — 需求文档 v1

## 1. 系统目标

* 在 **无互联网环境** 下，ESP32 启动后创建 Wi-Fi 热点（SoftAP）。
* 用户手机/电脑连上后，会被 **自动重定向到聊天室网页**（Captive Portal 效果）。
* 提供一个 **轻量聊天室**，支持群聊和私聊（广播发送，客户端过滤展示），消息仅为 **文字**。
* 服务器仅保留最近 **100 条消息**（FIFO 缓存），不做长期存储，掉线可补齐。

---

## 2. 功能需求

### 2.1 网络与接入

* **热点服务**

  * ESP32 启动时创建 SoftAP（默认 SSID `ESPChat`，可设 WPA2 密码）。
  * 最大支持 5\~8 个客户端。

* **Captive Portal 自动弹窗**

  * 配置 DNS 劫持：所有域名请求都解析到 `192.168.4.1`。
  * HTTP 服务器对所有请求返回聊天室页面。
  * 支持 **“登录到网络”** 协议，让手机/电脑自动弹出浏览器进入聊天室。

---

### 2.2 聊天功能

* **WebSocket 通道**

  * 路径 `/ws`。
  * 用户消息通过 WebSocket 发送到 ESP32。
  * ESP32 将收到的消息立即广播给所有在线用户。

* **消息模型（JSON）**

  ```json
  {
    "type": "text",
    "from": "uuid-123",
    "to": {
      "all": true,
      "users": ["uuid-456", "uuid-789"]
    },
    "name": "Alice",
    "data": "你好！",
    "id": 42,
    "timestamp": 1694601234
  }
  ```

  * `to.all = true` → 群聊消息。
  * `to.users` → 多个私聊对象 ID。
  * 消息依然广播给所有人，但客户端只显示与自己相关的部分。

* **消息存储（FIFO 缓存）**

  * ESP32 仅保存最近 **100 条消息**（JSON 环形缓存）。
  * 新消息覆盖最旧消息。
  * ESP32 重启后所有记录清空。

* **掉线重连补偿**

  * 客户端重新连接后，请求 `since_id = last_seen_id` 之后的消息，最多拉取 100 条。

---

### 2.3 用户识别与昵称

* **用户 ID**

  * 客户端首次进入时生成一个 UUID，存入 `localStorage`。
  * 同一设备重复进入时，沿用相同 UUID。

* **昵称**

  * 用户进入聊天室时可自定义昵称（默认值如 `User123`）。
  * 昵称显示在消息上。

---

### 2.4 前端 UI

* **聊天室界面**

  * **上方**：消息滚动区域（显示群聊/私聊消息）。
  * **下方**：输入框 + 发送按钮。
  * 系统提示消息（用户加入/离开）以特殊样式展示。

* **消息显示规则**

  * 群聊：所有人都能看到。
  * 私聊：消息广播给所有人，但客户端只显示 `to.users` 中包含自己的消息。

---

## 3. 非功能需求

* **实时性**：文字消息延迟 < 300ms。
* **容量**：消息缓存上限 100 条。
* **可靠性**：掉线重连能补齐最近消息。
* **易用性**：用户无需安装 App，自动弹出网页即可聊天。
* **存储**：不做长期保存，ESP32 重启清空。

---

## 4. 不包含的功能

* 图片/视频/文件传输。
* 用户登录认证。
* 长期存储/历史互助补偿。
* 消息加密。